---
description: RanchLink system architecture, full current state, pipeline, field definitions. Always apply.
alwaysApply: true
---

# RanchLink — Persistent System State
**Last updated:** 2026-02-27 (session 2 — contract redeployed)  
**Deployment:** https://ranch-link.vercel.app  
**GitHub:** https://github.com/ritxmalab/ranchLink  
**Supabase project:** utovzxpmfnzihurotqnv  
**Vercel project:** ritxma-integrations-projects/ranch-link (id: prj_NxhdtgXobdqmE07duN86PnK8BeQ5)

---

## Key Technical Constants (NEVER change these without confirmation)

| Item | Value |
|---|---|
| Chain | Base Mainnet (chainId: 8453) |
| Contract | `0x2BAc88732c526d25698Bcd8940048Dac3d3e6C3B` (RanchLinkTag ERC-721 — UUPS Upgradeable) |
| Server Wallet | `0x6781Eb019e553c3C3732c4B11e6859638282ED96` (clean EOA — deployer of new contract, has MINTER_ROLE + ADMIN_ROLE) |
| IPFS | Pinata (PINATA_JWT in .env.local and Vercel) |
| DB | Supabase — tables: tags, animals, ranches, batches, animal_events |
| QR URL pattern | `https://ranch-link.vercel.app/t/[tag_code]` |
| Animal card URL | `/a/[public_id]` (format: AUS0001, AUS0002...) |
| Tag code format | RL-001, RL-002... |
| Superadmin URL | `/superadmin` — password via SUPERADMIN_PASSWORD env var |
| Superadmin password | `ranchlink2026` (set in Vercel env) |

---

## Core Pipeline (NEVER deviate from this)

```
Server Wallet orchestrates everything.

1. SUPER ADMIN → Factory (/superadmin → Factory tab)
   - POST /api/factory/batches
   - Mints NFT IMMEDIATELY per tag → server wallet holds NFT
   - Pins initial IPFS metadata via Pinata
   - Generates: Batch ID, tag_code (RL-XXX), token_id, QR URL
   - Status after: on_chain_unclaimed
   ✅ FULLY BUILT

2. SUPER ADMIN → Assemble (/superadmin → Assemble tab)
   - Shows on_chain_unclaimed tags
   - Mark as assembled (assembled_at timestamp) then shipped (shipped_at)
   - POST /api/superadmin/assemble
   - Status flow: on_chain_unclaimed → assembled → shipped
   ✅ FULLY BUILT

3. SUPER ADMIN → Inventory (/superadmin → Inventory tab)
   - View all tags, retry failed mints
   - Retry Mint + Sync buttons per tag
   ✅ FULLY BUILT

4. USER → Claim/Scan
   - Rancher scans QR → /t/[tag_code]
   - If already attached: redirects to /a/[public_id]
   - If not attached: shows attach form
   ⚠️ PARTIALLY BUILT — no user account creation, no custodial wallet assignment

5. USER → Attach (ADD/FILL UP asset info)
   - POST /api/attach-tag
   - Photo upload: /api/upload-photo → Pinata Files API → photo_url in DB
   - Creates animal record with ALL field sections
   - Pins complete metadata to IPFS (Pinata)
   - Calls setCID() to update NFT tokenURI on-chain
   - Status after: attached → redirects to /a/[public_id]
   ✅ FULLY BUILT

6. USER → Ongoing Updates (/a/[public_id] → "Update Animal" button)
   - POST /api/update-animal
   - Event types: weight_update, health_check, vet_visit, update, note
   - Updates Supabase → pins new IPFS metadata → calls setCID() on-chain
   - Logs to animal_events table with IPFS CID + tx hash
   - Event history displayed on animal card
   ✅ FULLY BUILT

7. USER → Compliance
   - Recover credentials if lost
   - Delegate to staff member
   - Transfer NFT to own wallet (custodial → non-custodial)
   - Sell cattle on-chain
   ❌ NOT BUILT
```

---

## What IS Built (as of 2026-02-27)

| Feature | Endpoint/Page | Status |
|---|---|---|
| Factory batch creation + NFT mint | `POST /api/factory/batches` | ✅ |
| Assemble tab (assembly + shipment tracking) | `GET/POST /api/superadmin/assemble` | ✅ |
| Inventory + retry mint | `/superadmin` Inventory tab | ✅ |
| Superadmin password gate | `POST /api/superadmin/login` (cookie) | ✅ |
| Tag scan landing page | `/t/[tag_code]` | ✅ |
| Photo upload → IPFS | `POST /api/upload-photo` | ✅ |
| Full attach form (5 sections) | `POST /api/attach-tag` | ✅ |
| Animal public card with photo | `/a/[public_id]` | ✅ |
| Ongoing updates + event log | `POST /api/update-animal` | ✅ |
| NFT tokenURI update on attach+update | `setCID()` in ranchLinkTag.ts | ✅ |
| Rate limiting on all API routes | `lib/rate-limit.ts` | ✅ |
| Zod validation on all POST bodies | All API routes | ✅ |

## What is NOT Built

| Feature | Priority |
|---|---|
| User account creation at claim time | HIGH — needed for ownership |
| Custodial wallet assigned to farmer | HIGH — needed for RWA |
| NFT transfer from server wallet to farmer | HIGH — needed for true ownership |
| Compliance section (delegate, transfer, sell) | MEDIUM |
| Batch mint optimization (1 tx for N tags) | LOW — current: 1 tx per tag |
| Auth on superadmin beyond password cookie | LOW |

---

## Attach Form — ALL Field Sections

### BASIC (required)
- name, species, breed, birth_year, sex, size, photo_url

### IDENTIFICATION (optional)
- eid, secondary_id, tattoo, brand

### ADDITIONAL (optional)
- owner, head_count, labels (array)

### CALLFHOOD (optional)
- dam_id, sire_id, birth_weight, weaning_weight, weaning_date, yearling_weight, yearling_date

### PURCHASE (optional)
- seller, purchase_price, purchase_date

---

## Database Schema (current — Supabase)

### `animals` table key columns
```
id, public_id, name, species, breed, sex, birth_year, size, status,
eid, secondary_id, tattoo, brand,
owner, head_count, labels,
dam_id, sire_id, birth_weight, weaning_weight, weaning_date, yearling_weight, yearling_date,
seller, purchase_price, purchase_date,
photo_url,  ← added 2026-02-27
ranch_id, tag_id, created_at, updated_at
```

### `tags` table key columns
```
id, tag_code, chain, contract_address, token_id, mint_tx_hash,
batch_id, ranch_id, animal_id, status, activation_state,
metadata_cid, metadata_tx_hash, public_id,
assembled_at, shipped_at, assembled_by,  ← added 2026-02-27
created_at, updated_at
```

### `animal_events` table (NEW — created 2026-02-27)
```
id, animal_id, event_type, notes, weight, event_date,
metadata, ipfs_cid, tx_hash, created_at
```

### `batches` table key columns
```
id, name, batch_name, model, material, color, chain, count,
target_ranch_id, status, created_at
```

---

## Architecture v2.0 — Merkle Anchoring + ERC-1155 Lazy Mint (deployed 2026-02-25)
- **Factory**: one `anchorBatch()` tx per batch (any size, ~$0.05 flat)
- **Attach**: `lazyMint()` activates tag as ERC-1155 NFT at claim time (~$0.002/tag)
- **Legacy ERC-721** tags (RL-001 to RL-009) still work via `setCID` on old contract
- **New tag status**: `pre_identity` = anchored on-chain, NFT mints when farmer claims
- **ERC-1155 contract**: `0x559D8f4196578c2308e092225bdFbBc1AF88d0Fb` (Base Mainnet)
- **Merkle utility**: `apps/web/lib/blockchain/merkle.ts`
- **1155 blockchain lib**: `apps/web/lib/blockchain/ranchLinkTag1155.ts`

## Environment Variables (all set in Vercel + .env.local)

| Variable | Value / Notes |
|---|---|
| `NEXT_PUBLIC_CHAIN_ID` | `8453` (Base Mainnet) |
| `NEXT_PUBLIC_APP_URL` | `https://ranch-link.vercel.app` |
| `NEXT_PUBLIC_CONTRACT_TAG` | `0x2BAc88732c526d25698Bcd8940048Dac3d3e6C3B` (ERC-721 legacy) |
| `RANCHLINKTAG_ADDRESS` | `0x2BAc88732c526d25698Bcd8940048Dac3d3e6C3B` (ERC-721 legacy) |
| `RANCHLINKTAG_1155_ADDRESS` | `0x559D8f4196578c2308e092225bdFbBc1AF88d0Fb` (ERC-1155 v2) |
| `SERVER_WALLET_ADDRESS` | `0x6781Eb019e553c3C3732c4B11e6859638282ED96` |
| `NEXT_PUBLIC_ALCHEMY_BASE_RPC` | Alchemy Base Mainnet RPC |
| `PINATA_JWT` | Set in Vercel ✅ |
| `SUPABASE_SERVICE_KEY` | Set in Vercel ✅ |
| `SUPERADMIN_PASSWORD` | `ranchlink2026` |

---

## Confidence Levels (current)

| Step | Confidence |
|---|---|
| Factory mints NFT on Base Mainnet | 95% |
| QR code prints from browser | 95% |
| Farmer scans QR, form loads | 95% |
| Photo upload at attach time | 95% |
| Form submits, animal saved in Supabase | 95% |
| IPFS pin succeeds in production | 90% |
| setCID() updates NFT on-chain | 85% |
| Animal card displays photo + all data | 95% |
| Ongoing Updates synced to blockchain | 85% |
| Superadmin protected | 100% |

---

## Session Resume Protocol

At the start of any new session, I will:
1. Read this file (auto-loaded via alwaysApply)
2. Read `RANCHLINK_STATE.md` in the repo root for the latest session log
3. Check `git log --oneline -5` for latest commits
4. Report current state and pending next steps before touching anything

**One-command resume:** "Resume RanchLink" — I will read this file + RANCHLINK_STATE.md and give a full briefing.

---

## Critical Rules (NEVER violate)

- NEVER mint again on attach — ONE mint per tag during batch creation only
- NEVER change the contract address without explicit confirmation
- NEVER use Base Sepolia (84532) in production — always 8453
- setCID is called on attach AND on every ongoing update
- Tags without token_id CANNOT be attached or shipped — they must be minted first
- The server wallet holds ALL NFTs — farmer wallet transfer is future work
